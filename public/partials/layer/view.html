<div class="explorer-main-container explorer-layer">
    <div class="explorer-container">
        <div class="explorer-header">
            <div class="explorer-header-title">
                <h3 app-editable-text="vm.layer.name">{{ vm.layer.name }}</h3>
            </div>
            <div class="explorer-header-buttons">
                <a href="layers" class="btn btn-default" translate>Cancel</a>
                <a ng-click="vm.save()" class="btn btn-success" translate>Save layer</a>
            </div>
        </div>

        <div class="explorer-body">
            <section id="objectPanel" class="catalogSidebar">
                <menu>
                    <li class="search hand-cursor" ng-class="{'on': vm.selectedTab === 'properties'}">
                        <a ng-click="vm.selectedTab = 'properties'">
                            <i class="fa fa-gear"></i>
                        </a>
                    </li>

                    <li id="searchTabButton" class="search hand-cursor" ng-class="{'on': vm.selectedTab == 'elements'}">
                        <a ng-click="vm.selectedTab = 'elements'">
                            <span class="objectPanel-menu-label" translate>Layer elements</span>
                            <i class="fa fa-newspaper-o fa-2" aria-hidden="true"></i>
                        </a>
                    </li>
                    <li id="sourcesTabButton" class="search hand-cursor" ng-class="{'on': vm.selectedTab == 'sources'}">
                        <a ng-click="vm.selectedTab = 'sources'">
                            <span class="objectPanel-menu-label" translate>Sources</span>
                            <i class="fa fa-plug fa-2" aria-hidden="true"></i>
                        </a>
                    </li>
                    <li id="queriesTabButton" class="search hand-cursor" ng-class="{'on': vm.selectedTab == 'queries'}">
                        <a ng-click="vm.selectedTab = 'queries'">
                            <span class="objectPanel-menu-label" translate>Queries</span>
                            <i class="fa fa-map fa-2" aria-hidden="true"></i>
                        </a>
                    </li>
                </menu>

                <section class="content">
                    <section id="propertiesTab" class="results infinite" ng-show="vm.selectedTab == 'properties'" style="padding: 5px;">
                        <layer-object-properties object-type="vm.selectedItem" object="vm.theSelectedElement" on-delete="vm.deleteObject()" on-edit="vm.editObject"
                        layer="vm.layer" on-delete-element="vm.deleteSchemaElement" on-publish-element="vm.elementAdd"></layer-object-properties>
                    </section>

                    <section id="elementsTab" class="results infinite layer-elements" ng-show="vm.selectedTab == 'elements'">
                        <div class="container-fluid">
                            <div id="layerButtonGroup" class="btn-group">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span translate>Create</span>
                                    <span class="caret"></span>
                                </button>

                                <ul class="dropdown-menu layerNewButtonDropdown">
                                    <li><a href="" ng-click="vm.addFolder()" translate>New Folder</a></li>
                                    <li><a href="" ng-click="vm.createComposedElement()" translate>New Element</a></li>
                                </ul>
                            </div>
                        </div>

                        <section class="layer scrollPane">
                            <div class="layer-elements-tree">
                                <ul class="schema-container list-group" ui-sortable="vm.sortableOptions" ng-model="vm.layer.objects" ng-class="{'schema-element-container-placeholder': vm.onDrag, 'schema-element-container-default': !vm.onDrag}">
                                    <li class="innerCont list-group-item hand-cursor" ng-repeat="rootItem in vm.layer.objects" >
                                        <ng-include src="'nestable_item.html'"></ng-include>
                                    </li>
                                </ul>

                                <script type="text/ng-template" id="nestable_item.html">
                                    <div>
                                        <div class="schema-element"  ng-if="rootItem.elementRole == 'dimension' || rootItem.elementRole == 'measure'" >
                                            <i class="fa fa-cube wst-main-color" ng-show="rootItem.elementType != 'date' && rootItem.elementType != 'number' && rootItem.elementType != 'count' && (!rootItem.defaultAggregation)" data-toggle="tooltip" data-placement="top" title="{{rootItem.elementLabel}} (Dimmension)"></i>
                                            <i class="fa fa-reorder wst-main-color" ng-show="rootItem.elementType == 'number' || rootItem.elementType == 'count' || (rootItem.elementType == 'string' && rootItem.defaultAggregation)" data-toggle="tooltip" data-placement="top" title="{{rootItem.elementLabel}} (Metric)"></i>
                                            <i class="fa fa-calendar-o wst-main-color" ng-show="rootItem.elementType == 'date'" data-toggle="tooltip" data-placement="top"></i>
                                            <span ng-if="!rootItem.editing == true">{{rootItem.elementLabel}}</span>
                                            <i class="fa fa-wrench" style="color:#999999" ng-show="rootItem.isCustom"></i>
                                            <div ng-if="!rootItem.editing == true" class="schema-element-btn">
                                                <div class="btn btn-warning btn-xs delete-schema-element-btn" ng-click="vm.deleteSchemaElement(rootItem)" translate>Remove</div>
                                                <div class="btn btn-info btn-xs edit-schema-element-btn" ng-click="vm.editElement(rootItem)" translate>Edit</div>
                                            </div>
                                        </div>

                                        <div class="schema-folder" ng-if="rootItem.elementRole == 'folder'" >
                                           <i class="fa fa-caret-down"></i>
                                            <span ng-if="!rootItem.editing == true" class="" >{{rootItem.elementLabel}}</span>
                                            <span ng-if="rootItem.editing == true" class=""><input type="text" ng-model="rootItem.elementLabel" style="width:100px"></span>

                                            <div ng-if="!rootItem.editing == true" class="schema-element-btn">
                                                <div class="btn btn-danger btn-xs delete-schema-element-btn" ng-click="vm.deleteSchemaElement(rootItem)" translate>Delete</div>
                                                <div class="btn btn-info btn-xs edit-schema-element-btn" ng-click="rootItem.editing = true" translate>Edit</div>
                                            </div>

                                            <div ng-if="rootItem.editing == true" class="edit-schema-element-btn pull-right" ng-click="rootItem.editing = false" style="cursor:hand"><i class="fa fa-floppy-o save-folder-element-btn-icon" uib-tooltip="{{'Save folder label' | translate}}"></i></div>
                                        </div>
                                        <ul ng-if="rootItem.elementRole == 'folder'" class="schema-container list-group" ui-sortable="vm.sortableOptions" ng-model="rootItem.elements" ng-class="{'schema-element-container-placeholder': vm.onDrag, 'schema-element-container-default': !vm.onDrag}">
                                            <li class="innerCont list-group-item hand-cursor" ng-repeat="rootItem in rootItem.elements" >
                                                <ng-include src="'nestable_item.html'"></ng-include>
                                            </li>
                                        </ul>
                                    </div>
                                </script>
                             </div>
                        </section>

                        <div class="scrollTrack vScrollTrack">
                            <div class="scrollThumb" style="height: 72px; transform: translateY(0);"></div>
                        </div>
                        <div class="scrollTrack hScrollTrack">
                            <div class="scrollThumb disabled" style="width: 354px; transform: translateX(0);"></div>
                        </div>
                    </section>

                    <section id="sourcesTab" class="results infinite" ng-show="vm.selectedTab == 'sources'">
                        <section class="layer scrollPane">
                            <div class="container-fluid" style="min-height: 100%;">
                                <div ui-tree data-nodrop-enabled="true" data-drag-enabled="false">
                                    <ol ui-tree-nodes="" ng-model="vm.datasources">
                                        <li ng-repeat="item in vm.datasources" ui-tree-node>
                                            <div ui-tree-handle class="layer-tree-datasource selected-datasource" style="cursor: pointer;">
                                                <i ng-if="!item.isCollapsed" ng-click="vm.getDatasets(item)" class="fa fa-plus-square"></i>
                                                <i ng-if="item.isCollapsed" class="fa fa-minus-square" ng-click="item.isCollapsed = !item.isCollapsed" ></i>

                                                <span ng-disabled="item.loading || item.status == -1" ng-click="vm.getDatasets(item)">{{item.name}}</span>

                                                <i ng-if="(item.status == -1 || item.entities ) && !item.loading" class="fa fa-refresh" ng-click="vm.getDatasets(item)" style="color: #eee; font-size: 16px;"></i>

                                                <div id="fountainG" ng-if="item.loading">
                                                    <div id="fountainG_1" class="fountainG"></div>
                                                    <div id="fountainG_2" class="fountainG"></div>
                                                    <div id="fountainG_3" class="fountainG"></div>
                                                    <div id="fountainG_4" class="fountainG"></div>
                                                    <div id="fountainG_5" class="fountainG"></div>
                                                    <div id="fountainG_6" class="fountainG"></div>
                                                    <div id="fountainG_7" class="fountainG"></div>
                                                    <div id="fountainG_8" class="fountainG"></div>
                                                </div>
                                            </div>

                                            <ol ui-tree-nodes="" ng-model="item.entities">
                                                <li ng-repeat="collectionName in item.entities" ui-tree-node>
                                                    <div ui-tree-handle class="layer-tree-datasource-collection" style="font-weight: 100;">
                                                        <table style="width: 100%; cursor: default;">
                                                            <tr style="width: 100%;">
                                                                <td>
                                                                    <i class="fa fa-table" aria-hidden="true"></i>
                                                                </td>
                                                                <td class="layer-tree-td-name">{{ collectionName }}</td>
                                                                <td>
                                                                    <button type="button" ng-click="vm.addDatasetToLayer(item._id, collectionName)" class="btn btn-info btn-xs add-to-layer-btn" translate>Add</button>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </li>
                                            </ol>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                        </section>

                        <div class="scrollTrack vScrollTrack">
                            <div class="scrollThumb" style="height: 72px; transform: translateY(0);"></div>
                        </div>
                        <div class="scrollTrack hScrollTrack">
                            <div class="scrollThumb disabled" style="width: 354px; transform: translateX(0);"></div>
                        </div>
                    </section>

                    <section id="queriesTab" class="results infinite" ng-show="vm.selectedTab == 'queries'" style="padding: 5px;">
                        <a ng-click="vm.addSQL()" class="btn btn-info pull-right" style="margin-left: 5px; margin-right: 5px;" translate>Add SQL</a>
                        <div ng-if="collection.sql" ng-repeat="collection in vm.layer.params.schema">{{collection.collectionName}}</div>
                    </section>
                </section>
            </section>

            <div id="collections" class="canvas-parent" ng-click="vm.selectedCanvas($event)" style="left: 300px;">
                <div class="canvas canvas-wide flowchart-demo jtk-surface jtk-surface-nopan canvas-er" id="canvas" style="cursor: default;">
                    <div id="{{collection.collectionID}}-parent"  class="window jtk-node jsplumb-draggable" ng-style="{'left': collection.left, 'top': collection.top}" ng-repeat="collection in vm.layer.params.schema">
                        <div id="{{collection.collectionID}}" class=" jtk-header " style="overflow: hidden; padding-left: 2px;">
                            <div class="row">
                                <span class="col-md-1 jtk-field-icon" style="color: white;"><i class="fa fa-database"></i></span>

                                <span class="col-md-6 jtk-header-label" style="overflow: hidden; text-align: left;" ng-click="vm.selectCollection(collection,$event)">
                                    {{collection.collectionName}}
                                </span>

                                <span class="col-md-4">
                                    <span ng-click="vm.toggleFolded(collection)">
                                        <i ng-hide="collection.folded" class="jtk-field-selected fa fa-minus-square"></i>
                                        <i ng-show="collection.folded" class="jtk-field-selected fa fa-plus-square"></i>
                                    </span>

                                    <span>
                                        <i ng-hide="vm.allElementsAdded(collection)" class="jtk-field-icon fa fa-plus-square" ng-click="vm.promptAddAll(collection)" uib-tooltip="{{ 'Add all' | translate }}" ></i>
                                        <i ng-show="vm.allElementsAdded(collection)" class="jtk-field-selected fa fa-check-square" ></i>
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="jtk-field" id="{{element.elementID}}" ng-repeat="element in collection.elements" title="{{element.elementName}}" data-html="true" rel="tooltip" ng-click="vm.selectElement(element,$event)" ng-hide="collection.folded && !vm.isInAJoin(element)">
                            <table style="border: 0;">
                                <tr>
                                    <td class="jtk-field-icon"><i ng-show="!element.elementRole" class="fa fa-plus-square" ng-click="vm.elementAdd(element)" ></i></td>
                                    <td class="jtk-field-icon"><i ng-show="element.count" class="fa fa-superscript element-variable"></i></td>
                                    <td class="jtk-field-selected"><i ng-show="element.elementRole" class="fa fa-check-square"></i></td>
                                    <td class="jtk-field-label" ng-class="{'field-selected': element.elementRole}">{{element.elementName}}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
